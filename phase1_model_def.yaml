name: phase1_model_def
description: Create a ResNet50 (ImageNet1K_V2 weights) with the final head sized to num_classes and save model initialization and metadata.

inputs:
  - { name: categories_json, type: Dataset, description: "JSON file containing class categories (list of strings)" }

outputs:
  - { name: model_init, type: Model,   description: "Model initialization weights (torch saved state_dict)" }
  - { name: model_meta, type: Dataset, description: "Model metadata as JSON including image_size, mean, std, num_classes, categories" }

implementation:
  container:
    image: python:3.9
    command:
      - sh
      - -c
      - |
        # Install required dependencies
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        #!/usr/bin/env python3
        import argparse
        import json
        import os
        from pathlib import Path
        import torch
        import torch.nn as nn
        from torchvision.models import resnet50, ResNet50_Weights

        def main():
            parser = argparse.ArgumentParser()
            parser.add_argument('--categories_json', type=str, required=True)  # JSON file path
            parser.add_argument('--model_init', type=str, required=True)       # output file path
            parser.add_argument('--model_meta', type=str, required=True)       # output file path
            parser.add_argument('--image_size', type=int, default=224)
            args = parser.parse_args()

            # Ensure output directories exist
            Path(args.model_init).parent.mkdir(parents=True, exist_ok=True)
            Path(args.model_meta).parent.mkdir(parents=True, exist_ok=True)

            # Read categories from JSON file
            categories = json.loads(Path(args.categories_json).read_text())
            if not isinstance(categories, list) or not all(isinstance(c, str) for c in categories):
                raise ValueError("categories_json must be a JSON list of strings")
            num_classes = len(categories)
            if num_classes < 2:
                raise ValueError(f"Need >= 2 categories, got {num_classes}")

            print(f"Number of classes: {num_classes}")
            print(f"Categories: {categories}")

            # Initialize the ResNet50 model with pretrained weights
            weights = ResNet50_Weights.IMAGENET1K_V2
            model = resnet50(weights=weights)
            model.fc = nn.Sequential(
                nn.Dropout(p=0.2),
                nn.Linear(model.fc.in_features, num_classes)
            )

            # Save model state dictionary
            torch.save(model.state_dict(), args.model_init)

            # Save meta data including categories and model config
            meta = {
                "image_size": args.image_size,
                "mean": list(weights.transforms().mean),
                "std": list(weights.transforms().std),
                "num_classes": num_classes,
                "categories": categories
            }
            Path(args.model_meta).write_text(json.dumps(meta, indent=2))

            print(f"Saved model initialization to: {args.model_init}")
            print(f"Saved model metadata to: {args.model_meta}")
            print(f"Model metadata: {meta}")

        if __name__ == "__main__":
            main()

    args:
      - --categories_json
      - {inputPath: categories_json}
      - --model_init
      - {outputPath: model_init}
      - --model_meta
      - {outputPath: model_meta}
